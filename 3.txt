professional_player_system.py

import json
import pandas as pd
import numpy as np
import os

print("ğŸ PROFESSIONAL CRICKET PLAYER ANALYSIS SYSTEM")
print("="*70)
print("Final Year Project - Complete Player Database")
print("="*70)

# Load master database
try:
    with open(r'E:\cricket-prediction-project\data\global_cricket_players_fixed.json', 'r') as f:
        players_data = json.load(f)
    master_db = pd.DataFrame(players_data)
    print(f"âœ… Master Database Loaded: {len(master_db)} players across {master_db['country'].nunique()} countries")
except Exception as e:
    print(f"âŒ ERROR: Could not load 'E:\\cricket-prediction-project\\data\\global_cricket_players_fixed.json'. Error: {e}")
    print("ğŸ’¡ Ensure 'fix_json_format.py' ran successfully or the file exists.")
    exit()

# Load match statistics
batting_stats = pd.DataFrame()
bowling_stats = pd.DataFrame()
batting_perf = pd.DataFrame()
bowling_perf = pd.DataFrame()

try:
    batting_stats = pd.read_csv(r'E:\cricket-prediction-project\data\processed\players\batting_statistics.csv')
    bowling_stats = pd.read_csv(r'E:\cricket-prediction-project\data\processed\players\bowling_statistics.csv')
    batting_perf = pd.read_csv(r'E:\cricket-prediction-project\data\processed\players\batting_performances.csv')
    bowling_perf = pd.read_csv(r'E:\cricket-prediction-project\data\processed\players\bowling_performances.csv')
    print(f"âœ… Match Data: {len(batting_stats)} batsmen, {len(bowling_stats)} bowlers")
except Exception as e:
    print(f"âš ï¸ Warning: Match statistics not found. Using master database only. Error: {e}")

def export_player_ratings(output_file=r'E:\cricket-prediction-project\data\player_ratings.csv'):
    ratings = []
    for _, player in master_db.iterrows():
        batting_rating = 0
        bowling_rating = 0
        if 'Batsman' in player['role'] or 'Keeper' in player['role'] or 'All-Rounder' in player['role']:
            odi_avg = player['odi_average'] if pd.notna(player.get('odi_average')) else 0
            t20i_sr = player['t20i_strike_rate'] if pd.notna(player.get('t20i_strike_rate')) else 0
            ipl_avg = player['ipl_average'] if pd.notna(player.get('ipl_average')) else 0
            batting_rating = (min((odi_avg + ipl_avg) / 80 * 100, 100) * 0.5 + min(t20i_sr / 140 * 100, 100) * 0.5)
        if 'Bowler' in player['role'] or 'All-Rounder' in player['role']:
            odi_wickets = player['odi_wickets'] if pd.notna(player.get('odi_wickets')) else 0
            t20i_econ = player['t20i_economy'] if pd.notna(player.get('t20i_economy')) else 10
            ipl_wickets = player['ipl_wickets'] if pd.notna(player.get('ipl_wickets')) else 0
            bowling_rating = (min((odi_wickets + ipl_wickets) / 100 * 100, 100) * 0.5 + max(100 - (t20i_econ - 6) * 10, 0) * 0.5)
        ratings.append({
            'player_name': player['player_name'],
            'country': player['country'],
            'role': player['role'],
            'batting_rating': batting_rating,
            'bowling_rating': bowling_rating
        })
    pd.DataFrame(ratings).to_csv(output_file, index=False)
    print(f"ğŸ’¾ Player ratings exported to {output_file}")

def get_player_complete_profile(player_name):
    """
    Get complete player profile with ACCURATE information
    """
    player_master = master_db[master_db['player_name'].str.contains(player_name, case=False, na=False)]
    
    if len(player_master) == 0:
        print(f"âŒ Player '{player_name}' not found in master database")
        return None
    
    if len(player_master) > 1:
        print(f"\nâœ… Found {len(player_master)} players:")
        for i, row in player_master.iterrows():
            print(f"   {i+1}. {row['player_name']} ({row['country']})")
        
        try:
            choice = int(input("\n   Select player number: ")) - 1
            player_info = player_master.iloc[choice]
        except (ValueError, IndexError):
            print("âŒ Invalid selection. Exiting.")
            return None
    else:
        player_info = player_master.iloc[0]
    
    exact_name = player_info['player_name']
    
    print("\n" + "="*70)
    print(f"ğŸ COMPLETE PLAYER ANALYSIS: {exact_name}")
    print("="*70)
    
    # BASIC PROFILE
    print(f"\nğŸ‘¤ PLAYER PROFILE (Verified Information):")
    print(f"   Full Name: {exact_name}")
    print(f"   Country: {player_info['country']}")
    print(f"   Age: {player_info['age']} years")
    print(f"   Role: {player_info['role']}")
    print(f"   Batting Position: {player_info['batting_position']}")
    print(f"   Teams: {player_info['teams']}")
    print(f"   Formats: {player_info['formats']}")
    
    if player_info['is_young_star'] == 'Yes':
        print(f"   ğŸŒŸ YOUNG STAR - Rising Talent!")
    
    # BATTING ANALYSIS
    is_batsman = 'Batsman' in player_info['role'] or 'Keeper' in player_info['role'] or 'All-Rounder' in player_info['role']
    
    if is_batsman:
        print(f"\n{'='*70}")
        print("ğŸ BATTING ANALYSIS")
        print('='*70)
        
        print(f"\nğŸ¯ SIGNATURE SHOT (Speciality):")
        print(f"   {player_info['special_shot']}")
        print(f"   Batting Style: {player_info['batting_style']}")
        
        player_bat_stats = batting_stats[batting_stats['player'].str.contains(exact_name, case=False, na=False)] if not batting_stats.empty else pd.DataFrame()
        
        if len(player_bat_stats) > 0:
            stats = player_bat_stats.iloc[0]
            
            print(f"\nğŸ“Š CAREER STATISTICS (All Formats Combined):")
            print(f"   Innings Played: {int(stats['innings_played'])}")
            print(f"   Total Runs: {int(stats['total_runs'])}")
            print(f"   Batting Average: {stats['batting_average']:.2f}")
            print(f"   Strike Rate: {stats['avg_strike_rate']:.2f}")
            print(f"   Highest Score: {int(stats['highest_score'])}")
            
            print(f"\nğŸ¯ BOUNDARY STATISTICS:")
            print(f"   Total Fours: {int(stats['total_fours'])}")
            print(f"   Total Sixes: {int(stats['total_sixes'])}")
            print(f"   Total Boundaries: {int(stats['total_fours'] + stats['total_sixes'])}")
            print(f"   Boundary %: {stats['avg_boundary_pct']:.1f}%")
            
            print(f"\nâš¡ PERFORMANCE METRICS:")
            print(f"   Runs per Innings: {stats['avg_runs_per_innings']:.2f}")
            print(f"   Consistency Score: {stats['consistency_score']:.1f}/100")
            print(f"   Dot Ball %: {stats['avg_dot_pct']:.1f}%")
            
            if not batting_perf.empty:
                player_formats = batting_perf[batting_perf['player'].str.contains(exact_name, case=False, na=False)]
                
                if len(player_formats) > 0:
                    print(f"\nğŸ“ˆ FORMAT-WISE BREAKDOWN:")
                    for fmt in ['ODI', 'T20', 'IPL']:
                        fmt_data = player_formats[player_formats['format'] == fmt]
                        if len(fmt_data) > 0:
                            fmt_runs = fmt_data['runs'].sum()
                            fmt_innings = len(fmt_data)
                            fmt_avg = fmt_data['runs'].mean()
                            fmt_sr = fmt_data['strike_rate'].mean()
                            
                            print(f"\n   {fmt}:")
                            print(f"      Innings: {fmt_innings} | Runs: {int(fmt_runs)}")
                            print(f"      Average: {fmt_avg:.1f} | SR: {fmt_sr:.1f}")
            
            sr_score = min(stats['avg_strike_rate'] / 140 * 100, 100)
            avg_score = min(stats['batting_average'] / 45 * 100, 100)
            consistency_score = stats['consistency_score']
            overall_rating = (sr_score * 0.3 + avg_score * 0.4 + consistency_score * 0.3)
            
            print(f"\nâ­ OVERALL BATTING RATING: {overall_rating:.1f}/100")
            
            if overall_rating >= 85:
                grade = "â­â­â­â­â­ WORLD CLASS"
            elif overall_rating >= 75:
                grade = "â­â­â­â­ INTERNATIONAL CLASS"
            elif overall_rating >= 65:
                grade = "â­â­â­ VERY GOOD"
            elif overall_rating >= 50:
                grade = "â­â­ GOOD"
            else:
                grade = "â­ DEVELOPING"
            
            print(f"   Grade: {grade}")
        else:
            print(f"\n   âš ï¸ No match statistics available. Using master database stats.")
            has_odi = pd.notna(player_info.get('odi_matches')) and player_info.get('odi_matches', 0) > 0
            has_t20i = pd.notna(player_info.get('t20i_matches')) and player_info.get('t20i_matches', 0) > 0
            has_ipl = pd.notna(player_info.get('ipl_matches')) and player_info.get('ipl_matches', 0) > 0
            
            if has_odi:
                print(f"\nğŸ“Š ODI STATISTICS:")
                print(f"   Matches: {int(player_info['odi_matches'])}")
                print(f"   Runs: {int(player_info['odi_runs'])}")
                print(f"   Average: {player_info['odi_average']:.2f}")
                print(f"   Strike Rate: {player_info['odi_strike_rate']:.2f}")
                print(f"   Highest Score: {int(player_info['odi_highest_score'])}")
                if pd.notna(player_info.get('odi_hundreds')):
                    print(f"   Hundreds: {int(player_info['odi_hundreds'])}")
                    print(f"   Fifties: {int(player_info['odi_fifties'])}")
                print(f"   Sixes: {int(player_info['odi_sixes']) if pd.notna(player_info.get('odi_sixes')) else 'N/A'}")
            
            if has_t20i:
                print(f"\nğŸ“Š T20I STATISTICS:")
                print(f"   Matches: {int(player_info['t20i_matches'])}")
                print(f"   Runs: {int(player_info['t20i_runs'])}")
                print(f"   Average: {player_info['t20i_average']:.2f}")
                print(f"   Strike Rate: {player_info['t20i_strike_rate']:.2f}")
                print(f"   Highest Score: {int(player_info['t20i_highest_score'])}")
                if pd.notna(player_info.get('t20i_hundreds')):
                    print(f"   Hundreds: {int(player_info['t20i_hundreds'])}")
                    print(f"   Fifties: {int(player_info['t20i_fifties'])}")
                print(f"   Sixes: {int(player_info['t20i_sixes']) if pd.notna(player_info.get('t20i_sixes')) else 'N/A'}")
            
            if has_ipl:
                print(f"\nğŸ“Š IPL STATISTICS:")
                print(f"   Matches: {int(player_info['ipl_matches'])}")
                print(f"   Runs: {int(player_info['ipl_runs'])}")
                print(f"   Average: {player_info['ipl_average']:.2f}")
                print(f"   Strike Rate: {player_info['ipl_strike_rate']:.2f}")
                print(f"   Highest Score: {int(player_info['ipl_highest_score'])}")
                if pd.notna(player_info.get('ipl_hundreds')):
                    print(f"   Hundreds: {int(player_info['ipl_hundreds'])}")
                    print(f"   Fifties: {int(player_info['ipl_fifties'])}")
                print(f"   Sixes: {int(player_info['ipl_sixes']) if pd.notna(player_info.get('ipl_sixes')) else 'N/A'}")
            
            total_runs = sum([
                player_info['odi_runs'] if has_odi else 0,
                player_info['t20i_runs'] if has_t20i else 0,
                player_info['ipl_runs'] if has_ipl else 0
            ])
            total_matches = sum([
                player_info['odi_matches'] if has_odi else 0,
                player_info['t20i_matches'] if has_t20i else 0,
                player_info['ipl_matches'] if has_ipl else 0
            ])
            if total_matches > 0:
                print(f"\nğŸ’¯ OVERALL CAREER:")
                print(f"   Total Matches: {int(total_matches)}")
                print(f"   Total Runs: {int(total_runs)}")
                print(f"   Average per Match: {total_runs/total_matches:.2f}")
                
                overall_rating = (min(player_info.get('odi_average', 0) / 50 * 40, 40) +
                               min(player_info.get('t20i_strike_rate', 0) / 150 * 30, 30) +
                               min(player_info.get('ipl_average', 0) / 40 * 30, 30))
                print(f"\nâ­ OVERALL BATTING RATING: {overall_rating:.1f}/100")
                
                if overall_rating >= 85:
                    grade = "â­â­â­â­â­ WORLD CLASS"
                elif overall_rating >= 75:
                    grade = "â­â­â­â­ INTERNATIONAL CLASS"
                elif overall_rating >= 65:
                    grade = "â­â­â­ VERY GOOD"
                elif overall_rating >= 50:
                    grade = "â­â­ GOOD"
                else:
                    grade = "â­ DEVELOPING"
                
                print(f"   Grade: {grade}")
    
    # BOWLING ANALYSIS
    is_bowler = 'Bowler' in player_info['role'] or 'All-Rounder' in player_info['role']
    
    if is_bowler:
        print(f"\n{'='*70}")
        print("ğŸ¯ BOWLING ANALYSIS")
        print('='*70)
        
        print(f"\nğŸ¯ BOWLING SPECIALITY:")
        print(f"   {player_info['bowling_style']}")
        
        player_bowl_stats = bowling_stats[bowling_stats['player'].str.contains(exact_name, case=False, na=False)] if not bowling_stats.empty else pd.DataFrame()
        
        if len(player_bowl_stats) > 0:
            bowl = player_bowl_stats.iloc[0]
            
            print(f"\nğŸ“Š CAREER BOWLING STATISTICS:")
            print(f"   Spells Bowled: {int(bowl['spells_bowled'])}")
            print(f"   Total Wickets: {int(bowl['total_wickets'])}")
            print(f"   Bowling Average: {bowl['bowling_average']:.2f}")
            print(f"   Economy Rate: {bowl['avg_economy']:.2f}")
            print(f"   Strike Rate: {bowl['avg_bowling_sr']:.2f} balls/wicket")
            
            print(f"\nğŸ¯ CONTROL & EFFECTIVENESS:")
            print(f"   Dot Ball %: {bowl['avg_dot_pct']:.1f}%")
            print(f"   Wickets per Spell: {bowl['avg_wickets_per_spell']:.2f}")
            print(f"   Runs Conceded per Spell: {bowl['avg_runs_per_spell']:.2f}")
            
            if not bowling_perf.empty:
                player_bowl_formats = bowling_perf[bowling_perf['player'].str.contains(exact_name, case=False, na=False)]
                
                if len(player_bowl_formats) > 0:
                    print(f"\nğŸ“ˆ FORMAT-WISE BOWLING:")
                    for fmt in ['ODI', 'T20', 'IPL']:
                        fmt_bowl = player_bowl_formats[player_bowl_formats['format'] == fmt]
                        if len(fmt_bowl) > 0:
                            fmt_wickets = fmt_bowl['wickets'].sum()
                            fmt_spells = len(fmt_bowl)
                            fmt_econ = fmt_bowl['economy'].mean()
                            
                            print(f"\n   {fmt}:")
                            print(f"      Spells: {fmt_spells} | Wickets: {int(fmt_wickets)}")
                            print(f"      Economy: {fmt_econ:.2f}")
            
            econ_score = max(100 - (bowl['avg_economy'] - 6) * 10, 0)
            wicket_score = min(bowl['total_wickets'] / 80 * 100, 100)
            dot_score = bowl['avg_dot_pct']
            bowling_rating = (econ_score * 0.4 + wicket_score * 0.3 + dot_score * 0.3)
            
            print(f"\nâ­ OVERALL BOWLING RATING: {bowling_rating:.1f}/100")
            
            if bowling_rating >= 85:
                grade = "â­â­â­â­â­ WORLD CLASS"
            elif bowling_rating >= 75:
                grade = "â­â­â­â­ INTERNATIONAL CLASS"
            elif bowling_rating >= 65:
                grade = "â­â­â­ VERY GOOD"
            elif bowling_rating >= 50:
                grade = "â­â­ GOOD"
            else:
                grade = "â­ DEVELOPING"
            
            print(f"   Grade: {grade}")
        else:
            print(f"\n   âš ï¸ No bowling statistics available. Using master database stats.")
            has_odi_bowl = pd.notna(player_info.get('odi_wickets')) and player_info.get('odi_wickets', 0) > 0
            has_t20i_bowl = pd.notna(player_info.get('t20i_wickets')) and player_info.get('t20i_wickets', 0) > 0
            has_ipl_bowl = pd.notna(player_info.get('ipl_wickets')) and player_info.get('ipl_wickets', 0) > 0
            
            if has_odi_bowl:
                print(f"\nğŸ“Š ODI BOWLING:")
                print(f"   Matches: {int(player_info['odi_matches'])}")
                print(f"   Wickets: {int(player_info['odi_wickets'])}")
                print(f"   Bowling Average: {player_info['odi_bowling_average']:.2f}")
                print(f"   Economy Rate: {player_info['odi_economy']:.2f}")
                print(f"   Strike Rate: {player_info['odi_bowling_sr']:.1f} balls/wicket")
                if pd.notna(player_info.get('odi_best_bowling')):
                    print(f"   Best Bowling: {player_info['odi_best_bowling']}")
                if pd.notna(player_info.get('odi_five_wickets')):
                    print(f"   Five-wicket Hauls: {int(player_info['odi_five_wickets'])}")
            
            if has_t20i_bowl:
                print(f"\nğŸ“Š T20I BOWLING:")
                print(f"   Matches: {int(player_info['t20i_matches'])}")
                print(f"   Wickets: {int(player_info['t20i_wickets'])}")
                print(f"   Bowling Average: {player_info['t20i_bowling_average']:.2f}")
                print(f"   Economy Rate: {player_info['t20i_economy']:.2f}")
                print(f"   Strike Rate: {player_info['t20i_bowling_sr']:.1f} balls/wicket")
                if pd.notna(player_info.get('t20i_best_bowling')):
                    print(f"   Best Bowling: {player_info['t20i_best_bowling']}")
            
            if has_ipl_bowl:
                print(f"\nğŸ“Š IPL BOWLING:")
                print(f"   Matches: {int(player_info['ipl_matches'])}")
                print(f"   Wickets: {int(player_info['ipl_wickets'])}")
                print(f"   Bowling Average: {player_info['ipl_bowling_average']:.2f}")
                print(f"   Economy Rate: {player_info['ipl_economy']:.2f}")
                if pd.notna(player_info.get('ipl_best_bowling')):
                    print(f"   Best Bowling: {player_info['ipl_best_bowling']}")
            
            if has_odi_bowl or has_t20i_bowl or has_ipl_bowl:
                total_wickets = sum([
                    player_info['odi_wickets'] if has_odi_bowl else 0,
                    player_info['t20i_wickets'] if has_t20i_bowl else 0,
                    player_info['ipl_wickets'] if has_ipl_bowl else 0
                ])
                print(f"\nğŸ’¯ OVERALL BOWLING CAREER:")
                print(f"   Total Wickets: {int(total_wickets)}")
                
                bowling_rating = 0
                if has_odi_bowl:
                    bowling_rating += max(100 - (player_info['odi_economy'] - 6) * 10, 0) * 0.4
                    bowling_rating += min(player_info['odi_wickets'] / 80 * 100, 100) * 0.3
                if has_t20i_bowl:
                    bowling_rating += max(100 - (player_info['t20i_economy'] - 6) * 10, 0) * 0.3
                print(f"\nâ­ OVERALL BOWLING RATING: {bowling_rating:.1f}/100")
                
                if bowling_rating >= 85:
                    grade = "â­â­â­â­â­ WORLD CLASS"
                elif bowling_rating >= 75:
                    grade = "â­â­â­â­ INTERNATIONAL CLASS"
                elif bowling_rating >= 65:
                    grade = "â­â­â­ VERY GOOD"
                elif bowling_rating >= 50:
                    grade = "â­â­ GOOD"
                else:
                    grade = "â­ DEVELOPING"
                
                print(f"   Grade: {grade}")
    
    # TEAM RECOMMENDATION
    print(f"\n{'='*70}")
    print("ğŸ“ TEAM SELECTION RECOMMENDATION")
    print('='*70)
    
    print(f"\nâœ… RECOMMENDED POSITION: {player_info['batting_position']}")
    print(f"âœ… ROLE IN TEAM: {player_info['role']}")
    
    if 'All-Rounder' in player_info['role']:
        print(f"\nğŸ’ª ALL-ROUNDER ADVANTAGE:")
        print(f"   â€¢ Can contribute with both bat and ball")
        print(f"   â€¢ Provides balance to team composition")
        print(f"   â€¢ High-value player for any format")
    
    if player_info['is_young_star'] == 'Yes':
        print(f"\nğŸŒŸ YOUNG STAR STATUS:")
        print(f"   â€¢ Future of cricket")
        print(f"   â€¢ Invest in long-term development")
        print(f"   â€¢ High potential for growth")
    
    print("\n" + "="*70)
    
    return {
        'name': exact_name,
        'role': player_info['role'],
        'special_shot': player_info['special_shot'] if is_batsman else player_info['bowling_style']
    }

def list_all_players():
    """List all players by category"""
    print("\n" + "="*70)
    print("ğŸ COMPLETE PLAYER DATABASE")
    print("="*70)
    
    print(f"\nğŸ“Š Total Players: {len(master_db)}")
    
    print(f"\nğŸ‘¥ BY ROLE:")
    role_counts = master_db['role'].value_counts()
    for role, count in role_counts.items():
        print(f"   {role}: {count}")
    
    young_stars = master_db[master_db['is_young_star'] == 'Yes']
    print(f"\nğŸŒŸ YOUNG STARS ({len(young_stars)} players):")
    for _, player in young_stars.iterrows():
        print(f"   â€¢ {player['player_name']} ({player['age']}) - {player['role']}")
    
    print(f"\nğŸŒ BY COUNTRY:")
    country_counts = master_db['country'].value_counts().head(10)
    for country, count in country_counts.items():
        print(f"   {country}: {count} players")
    
    print(f"\nğŸ SEARCH OPTIONS:")
    print(f"   1. Search by player name")
    print(f"   2. View all young stars")
    print(f"   3. View all-rounders")
    print(f"   4. View bowlers")
    print(f"   5. View batsmen")
    
    try:
        choice = input(f"\n   Enter choice (1-5): ").strip()
        
        if choice == '1':
            name = input("   Enter player name: ").strip()
            get_player_complete_profile(name)
        elif choice == '2':
            print(f"\nğŸŒŸ YOUNG STARS:")
            for i, row in young_stars.iterrows():
                print(f"   {i+1}. {row['player_name']}")
            num = int(input("\n   Select player number: ")) - 1
            get_player_complete_profile(young_stars.iloc[num]['player_name'])
        elif choice == '3':
            all_rounders = master_db[master_db['role'].str.contains('All-Rounder', na=False)]
            print(f"\nğŸ’ª ALL-ROUNDERS ({len(all_rounders)}):")
            for i, row in all_rounders.iterrows():
                print(f"   {i+1}. {row['player_name']} - {row['role']}")
            num = int(input("\n   Select player number: ")) - 1
            get_player_complete_profile(all_rounders.iloc[num]['player_name'])
        elif choice == '4':
            bowlers = master_db[master_db['role'].str.contains('Bowler', na=False) & 
                               ~master_db['role'].str.contains('All-Rounder', na=False)]
            print(f"\nğŸ¯ PURE BOWLERS ({len(bowlers)}):")
            for i, row in bowlers.iterrows():
                print(f"   {i+1}. {row['player_name']} - {row['bowling_style']}")
            num = int(input("\n   Select player number: ")) - 1
            get_player_complete_profile(bowlers.iloc[num]['player_name'])
        elif choice == '5':
            batsmen = master_db[master_db['role'].str.contains('Batsman', na=False) & 
                               ~master_db['role'].str.contains('All-Rounder', na=False)]
            print(f"\nğŸ PURE BATSMEN ({len(batsmen)}):")
            for i, row in batsmen.iterrows():
                print(f"   {i+1}. {row['player_name']} - {row['special_shot']}")
            num = int(input("\n   Select player number: ")) - 1
            get_player_complete_profile(batsmen.iloc[num]['player_name'])
        
        print(f"\n\nğŸ”„ Search another player? (y/n): ", end="")
        if input().strip().lower() == 'y':
            list_all_players()
    except (ValueError, IndexError):
        print("âŒ Invalid input. Returning to main menu.")

# Run
if __name__ == "__main__":
    print("\nğŸ® WELCOME TO PROFESSIONAL PLAYER ANALYSIS SYSTEM")
    print("="*70)
    
    try:
        export_player_ratings()
        list_all_players()
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ Exiting... Thank you!")
    except Exception as e:
        print(f"\nâŒ Error: {e}")

python predictor_fixed.py

import pandas as pd
import pickle
import sys
import os

# Add project root to path
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

print("ğŸ CRICKET MATCH PREDICTOR - Enhanced Version")
print("="*70)
print("Model Accuracy: 73% | Dataset: 7,000+ matches")
print("="*70)

# Load model and data
print("\nâ³ Loading model and data...")

try:
    model_path = os.path.join(project_root, 'models', 'ultimate_ensemble_model.pkl')
    team_stats_path = os.path.join(project_root, 'models', 'team_statistics.pkl')
    venue_path = os.path.join(project_root, 'data', 'processed', 'venue_statistics_complete.csv')
    team_list_path = os.path.join(project_root, 'data', 'processed', 'team_list.csv')
    venue_list_path = os.path.join(project_root, 'data', 'processed', 'venue_list.csv')
    
    with open(model_path, 'rb') as f:
        model = pickle.load(f)
    
    with open(team_stats_path, 'rb') as f:
        team_stats = pickle.load(f)
    
    venue_stats = pd.read_csv(venue_path)
    team_list = pd.read_csv(team_list_path)
    venue_list = pd.read_csv(venue_list_path)
    
    print(f"âœ… Model loaded: {len(team_stats)} teams, {len(venue_stats)} venues")
    
except FileNotFoundError as e:
    print(f"âŒ Error: {e}")
    print("\nğŸ’¡ Run: python scripts/quick_save_model.py")
    sys.exit(1)

def show_teams():
    """Display available teams"""
    teams = sorted(team_list['team_name'].tolist())
    print(f"\nğŸ AVAILABLE TEAMS ({len(teams)} teams):")
    print("="*70)
    for i in range(0, len(teams), 3):
        row = teams[i:i+3]
        line = ""
        for j, team in enumerate(row):
            line += f"{i+j+1:3d}. {team:25s} "
        print(line)
    return teams

def show_venues():
    """Display ALL venues"""
    venues = venue_list['venue_name'].tolist()
    print(f"\nğŸŒ ALL VENUES ({len(venues)} stadiums):")
    print("="*70)
    print("ğŸ’¡ Tip: Type venue number or search by name (e.g., 'wankhede' or 'eden')")
    print("-"*70)
    
    # Display in 2 columns
    for i in range(0, len(venues), 2):
        if i + 1 < len(venues):
            print(f"{i+1:3d}. {venues[i]:45s} {i+2:3d}. {venues[i+1]}")
        else:
            print(f"{i+1:3d}. {venues[i]}")
    
    return venues

def predict_match():
    """Interactive prediction with enhanced confidence"""
    
    # Step 1: Teams
    print("\n" + "="*70)
    print("STEP 1: SELECT TEAMS")
    print("="*70)
    
    teams = show_teams()
    
    print("\nğŸ Enter Team 1 (Batting First):")
    print("   (Enter number, name, or partial name)")
    team1_input = input("   â†’ ").strip()
    
    if team1_input.isdigit() and int(team1_input) <= len(teams):
        team1 = teams[int(team1_input) - 1]
    else:
        matching = [t for t in teams if team1_input.lower() in t.lower()]
        if matching:
            team1 = matching[0]
            if len(matching) > 1:
                print(f"   Found {len(matching)} matches, selected: {team1}")
        else:
            team1 = 'India'
            print(f"   âš ï¸ Not found, using default: {team1}")
    
    print(f"   âœ… Selected: {team1}")
    
    print("\nğŸ Enter Team 2 (Chasing):")
    print("   (Enter number, name, or partial name)")
    team2_input = input("   â†’ ").strip()
    
    if team2_input.isdigit() and int(team2_input) <= len(teams):
        team2 = teams[int(team2_input) - 1]
    else:
        matching = [t for t in teams if team2_input.lower() in t.lower()]
        if matching:
            team2 = matching[0]
            if len(matching) > 1:
                print(f"   Found {len(matching)} matches, selected: {team2}")
        else:
            team2 = 'Australia'
            print(f"   âš ï¸ Not found, using default: {team2}")
    
    print(f"   âœ… Selected: {team2}")
    
    # Step 2: Venue
    print("\n" + "="*70)
    print("STEP 2: SELECT VENUE")
    print("="*70)
    
    venues = show_venues()
    
    print("\nğŸŒ Enter Venue:")
    print("   (Enter number or search by name)")
    venue_input = input("   â†’ ").strip()
    
    if venue_input.isdigit() and int(venue_input) <= len(venues):
        venue = venues[int(venue_input) - 1]
    else:
        matching = [v for v in venues if venue_input.lower() in v.lower()]
        if matching:
            venue = matching[0]
            if len(matching) > 1:
                print(f"   Found {len(matching)} matches:")
                for i, v in enumerate(matching[:5], 1):
                    print(f"      {i}. {v}")
                print(f"   Selected: {venue}")
        else:
            venue = venues[0]
            print(f"   âš ï¸ Not found, using: {venue}")
    
    print(f"   âœ… Selected: {venue}")
    
    # Step 3: Stats
    print("\n" + "="*70)
    print("STEP 3: ENTER MATCH STATISTICS")
    print("="*70)
    
    print(f"\nğŸ“Š {team1} batting first at {venue}")
    
    while True:
        try:
            runs = int(input("\nğŸ Runs scored (80-400): "))
            if 80 <= runs <= 400:
                break
            print("   âš ï¸ Enter realistic score (80-400)")
        except:
            print("   âŒ Invalid input")
    
    while True:
        try:
            wickets = int(input("ğŸ Wickets lost (0-10): "))
            if 0 <= wickets <= 10:
                break
            print("   âš ï¸ Enter 0-10")
        except:
            print("   âŒ Invalid input")
    
    while True:
        try:
            run_rate = float(input("ğŸ Run rate (4-15): "))
            if 4 <= run_rate <= 15:
                break
            print("   âš ï¸ Enter 4-15")
        except:
            print("   âŒ Invalid input")
    
    # Predict
    print("\nâ³ Analyzing match data...")
    print("   â€¢ Team historical performance")
    print("   â€¢ Venue statistics")
    print("   â€¢ Current match situation")
    
    t1_stats = team_stats.get(team1, {'wr': 0.5, 'bat_wr': 0.5, 'avg_score': 150})
    t2_stats = team_stats.get(team2, {'wr': 0.5, 'chase_wr': 0.5})
    
    venue_row = venue_stats[venue_stats['venue'] == venue]
    if len(venue_row) > 0:
        v_avg = venue_row['v_avg'].values[0]
        v_std = venue_row['v_std'].values[0]
        v_bat_adv = venue_row['v_bat_adv'].values[0]
        v_rr = venue_row['v_rr'].values[0]
    else:
        v_avg, v_std, v_bat_adv, v_rr = 160, 25, 0.5, 7.0
    
    # Features
    score_above_venue = (runs - v_avg) / v_std
    team_strength = t1_stats['wr'] - t2_stats['wr']
    situation_advantage = t1_stats['bat_wr'] - t2_stats['chase_wr']
    wickets_remaining = 10 - wickets
    wicket_quality = wickets_remaining / 10 * (runs / 150)
    big_score = 1 if runs >= v_avg + 15 else 0
    low_wickets = 1 if wickets <= 5 else 0
    dominant_performance = big_score * low_wickets
    balanced_match = 1 if abs(team_strength) < 0.15 else 0
    score_normalized = runs / v_avg
    overall_strength = (
        score_above_venue * 0.4 + team_strength * 0.3 +
        wicket_quality * 0.2 + situation_advantage * 0.1
    )
    
    user_input = pd.DataFrame({
        'runs': [runs], 'wickets': [wickets], 'rr': [run_rate],
        't1_wr': [t1_stats['wr']], 't2_wr': [t2_stats['wr']],
        't1_bat_wr': [t1_stats['bat_wr']], 't2_chase_wr': [t2_stats['chase_wr']],
        'v_avg': [v_avg], 'v_bat_adv': [v_bat_adv],
        'score_above_venue': [score_above_venue], 'team_strength': [team_strength],
        'situation_advantage': [situation_advantage], 'wickets_remaining': [wickets_remaining],
        'wicket_quality': [wicket_quality], 'big_score': [big_score],
        'low_wickets': [low_wickets], 'dominant_performance': [dominant_performance],
        'balanced_match': [balanced_match], 'score_normalized': [score_normalized],
        'overall_strength': [overall_strength]
    })
    
    prediction = model.predict(user_input)[0]
    probability = model.predict_proba(user_input)[0]
    
    # Results
    print("\n" + "="*70)
    print("ğŸ¯ MATCH PREDICTION RESULTS")
    print("="*70)
    
    print(f"\nğŸ“‹ Match Summary:")
    print(f"   Teams: {team1} vs {team2}")
    print(f"   Venue: {venue}")
    print(f"   Score: {runs}/{wickets} (RR: {run_rate})")
    
    print(f"\nğŸ† PREDICTION:")
    
    # Enhanced confidence
    max_prob = max(probability)
    if max_prob >= 0.80:
        confidence_level = "ğŸ”¥ VERY HIGH (80%+)"
        confidence_desc = "Strong prediction - Clear favorite based on data"
    elif max_prob >= 0.70:
        confidence_level = "âœ… HIGH (70-80%)"
        confidence_desc = "Good prediction with solid historical evidence"
    elif max_prob >= 0.60:
        confidence_level = "âš ï¸ MODERATE (60-70%)"
        confidence_desc = "Slight edge to winner - Match could be competitive"
    else:
        confidence_level = "â“ LOW (<60%)"
        confidence_desc = "Very close match - High uncertainty"
    
    if prediction == 1:
        print(f"   ğŸ† {team1} WILL WIN!")
        print(f"   Win Probability: {probability[1]*100:.1f}%")
    else:
        print(f"   ğŸ† {team2} WILL WIN!")
        print(f"   Win Probability: {probability[0]*100:.1f}%")
    
    print(f"\nğŸ¯ Confidence Level: {confidence_level}")
    print(f"   ğŸ“ {confidence_desc}")
    
    print(f"\nğŸ“Š Detailed Win Probabilities:")
    print(f"   {team1}: {probability[1]*100:.1f}%")
    print(f"   {team2}: {probability[0]*100:.1f}%")
    
    prob_diff = abs(probability[1] - probability[0]) * 100
    print(f"   Margin: {prob_diff:.1f}% difference")
    
    if prob_diff < 10:
        print(f"   âš¡ VERY CLOSE MATCH - Could go either way!")
    elif prob_diff < 20:
        print(f"   ğŸ“Š COMPETITIVE - Slight edge to predicted winner")
    elif prob_diff < 40:
        print(f"   ğŸ’ª CLEAR FAVORITE - Strong advantage")
    else:
        print(f"   ğŸš€ DOMINANT - Overwhelming favorite")
    
    print(f"\nğŸŒ Venue Analysis:")
    print(f"   Average Score: {v_avg:.0f} runs")
    print(f"   Batting First Success: {v_bat_adv*100:.0f}%")
    print(f"   Target: {runs} ({'+' if runs > v_avg else ''}{runs - v_avg:.0f} vs average)")
    
    if runs > v_avg + 20:
        print(f"   ğŸ’ª EXCELLENT SCORE - Well above venue average!")
    elif runs > v_avg:
        print(f"   âœ… GOOD SCORE - Above venue average")
    elif runs > v_avg - 15:
        print(f"   ğŸ“Š PAR SCORE - Around venue average")
    else:
        print(f"   âš ï¸ BELOW PAR - Below venue average")
    
    print("\n" + "="*70)
    
    # Another?
    print("\nğŸ”„ Predict another match? (y/n): ", end="")
    if input().strip().lower() == 'y':
        predict_match()
    else:
        print("\nğŸ‘‹ Thank you for using Cricket Match Predictor!")
        print("="*70)

# Run
if __name__ == "__main__":
    try:
        predict_match()
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ Exiting... Thank you!")


playing_xi_selector.py



import json
import pandas as pd
import numpy as np
import os

print("ğŸ PLAYING XI SELECTOR SYSTEM")
print("="*70)
print("Select best 11 players based on venue & opposition")
print("="*70)

# Load player database
try:
    with open(r'E:\cricket-prediction-project\data\global_cricket_players_fixed.json', 'r') as f:
        players_data = json.load(f)
    df = pd.DataFrame(players_data)
    print(f"âœ… Loaded {len(df)} players")
except Exception as e:
    print(f"âŒ Error loading database: {e}")
    print("ğŸ’¡ Ensure 'fix_json_format.py' ran successfully.")
    exit()

# Load venue statistics
try:
    venue_stats = pd.read_csv(r'E:\cricket-prediction-project\data\processed\venue_statistics_complete.csv')
    print(f"âœ… Loaded {len(venue_stats)} venues")
except Exception as e:
    print(f"âš ï¸ No venue stats found - using defaults. Error: {e}")
    venue_stats = pd.DataFrame({
        'venue': ['Generic Stadium', 'Wankhede', 'Eden Gardens'],
        'v_avg': [165, 180, 170],
        'v_std': [25, 30, 28],
        'v_bat_adv': [0.5, 0.6, 0.55],
        'v_rr': [7.0, 7.5, 7.2]
    })

def export_team_xi(selected_df, country, venue, opposition, match_format, output_file=r'E:\cricket-prediction-project\data\selected_xi.csv'):
    """Export selected XI to CSV"""
    selected_df['country'] = country
    selected_df['venue'] = venue
    selected_df['opposition'] = opposition
    selected_df['format'] = match_format
    selected_df.to_csv(output_file, index=False)
    print(f"ğŸ’¾ Playing XI exported to {output_file}")

def select_best_xi(country, venue, opposition, match_format='T20'):
    """
    Select best Playing XI based on:
    - Country (which team)
    - Venue (ground characteristics)
    - Opposition (head-to-head consideration)
    - Format (ODI/T20)
    """
    print("\n" + "="*70)
    print(f"ğŸ SELECTING PLAYING XI")
    print("="*70)
    print(f"   Team: {country}")
    print(f"   Venue: {venue}")
    print(f"   Opposition: {opposition}")
    print(f"   Format: {match_format}")
    
    team_players = df[df['country'] == country].copy()
    
    if len(team_players) == 0:
        print(f"\nâŒ No players found for {country}")
        return None
    
    print(f"\nğŸ“Š Squad Size: {len(team_players)} players available")
    
    # Analyze venue
    venue_info = venue_stats[venue_stats['venue'].str.contains(venue, case=False, na=False)]
    
    if len(venue_info) > 0:
        venue_avg_score = venue_info['v_avg'].values[0]
        venue_bat_first_adv = venue_info['v_bat_adv'].values[0]
        venue_type = ("High-Scoring (Batting Friendly)" if venue_avg_score > 180 else
                      "Moderate-Scoring (Balanced)" if venue_avg_score > 160 else
                      "Low-Scoring (Bowling Friendly)")
    else:
        venue_avg_score = 165
        venue_bat_first_adv = 0.5
        venue_type = "Unknown (Using defaults)"
    
    print(f"\nğŸŸï¸ VENUE ANALYSIS:")
    print(f"   Type: {venue_type}")
    print(f"   Average Score: {venue_avg_score:.0f}")
    print(f"   Batting First Win %: {venue_bat_first_adv*100:.0f}%")
    
    # Calculate player scores
    player_scores = []
    for idx, player in team_players.iterrows():
        score = 0
        if match_format == 'ODI':
            runs = player.get('odi_runs', 0)
            avg = player.get('odi_average', 0)
            sr = player.get('odi_strike_rate', 0)
            wickets = player.get('odi_wickets', 0)
            economy = player.get('odi_economy', 10)
        else:  # T20
            runs = player.get('t20i_runs', 0) if pd.notna(player.get('t20i_runs')) else player.get('ipl_runs', 0)
            avg = player.get('t20i_average', 0) if pd.notna(player.get('t20i_average')) else player.get('ipl_average', 0)
            sr = player.get('t20i_strike_rate', 0) if pd.notna(player.get('t20i_strike_rate')) else player.get('ipl_strike_rate', 0)
            wickets = player.get('t20i_wickets', 0) if pd.notna(player.get('t20i_wickets')) else player.get('ipl_wickets', 0)
            economy = player.get('t20i_economy', 10) if pd.notna(player.get('t20i_economy')) else player.get('ipl_economy', 10)
        
        runs = 0 if pd.isna(runs) else runs
        avg = 0 if pd.isna(avg) else avg
        sr = 0 if pd.isna(sr) else sr
        wickets = 0 if pd.isna(wickets) else wickets
        economy = 10 if pd.isna(economy) else economy
        
        if 'Batsman' in player['role'] or 'Keeper' in player['role'] or 'All-Rounder' in player['role']:
            batting_score = (runs / 100) + (avg / 10) + (sr / 30)
            if venue_avg_score > 180 and sr > 140:
                batting_score *= 1.2
            elif venue_avg_score < 150 and avg > 35:
                batting_score *= 1.1
            score += batting_score * 10
        
        if 'Bowler' in player['role'] or 'All-Rounder' in player['role']:
            bowling_score = (wickets / 20) + ((10 - economy) / 2)
            if venue_avg_score < 150:
                bowling_score *= 1.3
            score += bowling_score * 10
        
        if 'All-Rounder' in player['role']:
            score *= 1.15
        if player['is_young_star'] == 'Yes':
            score *= 1.05
        
        player_scores.append({
            'name': player['player_name'],
            'role': player['role'],
            'batting_position': player['batting_position'],
            'score': score,
            'runs': runs,
            'avg': avg,
            'sr': sr,
            'wickets': wickets,
            'economy': economy
        })
    
    player_scores_df = pd.DataFrame(player_scores).sort_values('score', ascending=False)
    
    # Select balanced team
    selected_xi = []
    openers = player_scores_df[player_scores_df['batting_position'].str.contains('1-2|1-3', na=False)].head(2)
    selected_xi.extend(openers.to_dict('records'))
    remaining = player_scores_df[~player_scores_df['name'].isin([p['name'] for p in selected_xi])]
    
    middle_order = remaining[remaining['batting_position'].str.contains('3|4|5', na=False)].head(3)
    selected_xi.extend(middle_order.to_dict('records'))
    remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
    
    all_rounders = remaining[remaining['role'].str.contains('All-Rounder', na=False)].head(2)
    selected_xi.extend(all_rounders.to_dict('records'))
    remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
    
    pace_bowlers = remaining[remaining['role'].str.contains('Fast Bowler', na=False)].head(2)
    selected_xi.extend(pace_bowlers.to_dict('records'))
    remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
    
    spin_bowlers = remaining[remaining['role'].str.contains('Spin Bowler', na=False)].head(2)
    selected_xi.extend(spin_bowlers.to_dict('records'))
    remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
    
    while len(selected_xi) < 11 and len(remaining) > 0:
        selected_xi.append(remaining.iloc[0].to_dict())
        remaining = remaining.iloc[1:]
    
    selected_df = pd.DataFrame(selected_xi)
    batting_positions = {
        '1-2': 1, '1-3': 1, '3-4': 3, '4-5': 4, '5-6': 5, '5-7': 6,
        '6-7': 6, '7-8': 7, '8-9': 8, '9-11': 9, '10-11': 10, '11': 11
    }
    selected_df['sort_order'] = selected_df['batting_position'].map(
        lambda x: min([batting_positions.get(p.strip(), 10) for p in str(x).split('-')])
    )
    selected_df = selected_df.sort_values('sort_order')
    
    print(f"\n{'='*70}")
    print(f"ğŸ† SELECTED PLAYING XI FOR {country}")
    print('='*70)
    print(f"\nğŸ BATTING ORDER:")
    for i, player in enumerate(selected_df.to_dict('records'), 1):
        position_info = f"({player['batting_position']})"
        stats = (f"Wickets: {int(player['wickets'])} | Econ: {player['economy']:.2f}" if 'Bowler' in player['role'] and 'All-Rounder' not in player['role']
                 else f"Runs: {int(player['runs'])} @ {player['avg']:.1f} | Wickets: {int(player['wickets'])}" if 'All-Rounder' in player['role']
                 else f"Runs: {int(player['runs'])} @ {player['avg']:.1f} | SR: {player['sr']:.1f}")
        print(f"   {i:2d}. {player['name']:30s} {position_info:8s} - {player['role']}")
        print(f"       {stats}")
    
    print(f"\nğŸ“Š TEAM COMPOSITION:")
    batsmen = len([p for p in selected_xi if 'Batsman' in p['role'] or 'Keeper' in p['role']])
    all_rounders_count = len([p for p in selected_xi if 'All-Rounder' in p['role']])
    bowlers = len([p for p in selected_xi if 'Bowler' in p['role'] and 'All-Rounder' not in p['role']])
    print(f"   Batsmen/Keepers: {batsmen}")
    print(f"   All-Rounders: {all_rounders_count}")
    print(f"   Pure Bowlers: {bowlers}")
    
    print(f"\nğŸ¯ BOWLING ATTACK:")
    pace = len([p for p in selected_xi if 'Fast' in p['role']])
    spin = len([p for p in selected_xi if 'Spin' in p['role']])
    print(f"   Pace Bowlers: {pace}")
    print(f"   Spin Bowlers: {spin}")
    
    print(f"\nğŸ’ª TEAM STRENGTHS:")
    avg_sr = selected_df['sr'].mean()
    if avg_sr > 135:
        print(f"   âš¡ EXPLOSIVE batting lineup (Avg SR: {avg_sr:.1f})")
    elif avg_sr > 120:
        print(f"   âœ… BALANCED batting lineup (Avg SR: {avg_sr:.1f})")
    else:
        print(f"   ğŸ“Š SOLID batting lineup (Avg SR: {avg_sr:.1f})")
    
    if venue_avg_score > 180 and avg_sr > 135:
        print(f"   ğŸ¯ Well-suited for HIGH-SCORING venue")
    elif venue_avg_score < 150 and bowlers >= 5:
        print(f"   ğŸ¯ Strong BOWLING attack for LOW-SCORING venue")
    
    print("\n" + "="*70)
    
    export_team_xi(selected_df, country, venue, opposition, match_format)
    return selected_df

def team_selection_menu():
    while True:
        print("\n" + "="*70)
        print("ğŸ TEAM SELECTION MENU")
        print("="*70)
        
        countries = sorted(df['country'].unique())
        print(f"\nğŸŒ AVAILABLE TEAMS:")
        for i, country in enumerate(countries, 1):
            player_count = len(df[df['country'] == country])
            print(f"   {i:2d}. {country:20s} ({player_count} players)")
        
        print(f"\n   0. Exit")
        
        try:
            choice = input("\n   Select team number: ").strip()
            if choice == '0':
                print("\nğŸ‘‹ Thank you!")
                break
            
            team_idx = int(choice) - 1
            if team_idx < 0 or team_idx >= len(countries):
                print("âŒ Invalid selection!")
                continue
            
            selected_team = countries[team_idx]
            print(f"\nğŸ†š SELECT OPPOSITION:")
            for i, country in enumerate(countries, 1):
                if country != selected_team:
                    print(f"   {i:2d}. {country}")
            
            opp_choice = int(input("\n   Opposition number: ")) - 1
            opposition = [c for c in countries if c != selected_team][opp_choice]
            
            print(f"\nğŸŸï¸ ENTER VENUE:")
            print("   Examples: Wankhede, Eden Gardens, MCG, Lord's, etc.")
            venue = input("   Venue: ").strip() or "Generic Stadium"
            
            print(f"\nğŸ SELECT FORMAT:")
            print("   1. T20")
            print("   2. ODI")
            format_choice = input("   Format: ").strip()
            match_format = 'ODI' if format_choice == '2' else 'T20'
            
            select_best_xi(selected_team, venue, opposition, match_format)
            
            print(f"\nğŸ”„ Select another team? (y/n): ", end="")
            if input().strip().lower() != 'y':
                break
        except Exception as e:
            print(f"\nâŒ Error: {e}")
            continue

if __name__ == "__main__":
    try:
        team_selection_menu()
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ Exiting...")

web_complete.py

from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
import pickle
import pandas as pd
import json
import os

# Get the base directory
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(BASE_DIR)

# Initialize Flask with correct paths
app = Flask(__name__,
            template_folder=os.path.join(PROJECT_ROOT, 'frontend', 'templates'),
            static_folder=os.path.join(PROJECT_ROOT, 'frontend', 'static'))
CORS(app)

print("="*70)
print("ğŸŒ LOADING ENHANCED CRICKET ANALYSIS SYSTEM...")
print("="*70)
print(f"ğŸ“ Base Directory: {BASE_DIR}")
print(f"ğŸ“ Project Root: {PROJECT_ROOT}")
print(f"ğŸ“ Templates: {app.template_folder}")
print("="*70)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOAD ALL MODELS AND DATA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

try:
    model_path = os.path.join(PROJECT_ROOT, 'models', 'ultimate_ensemble_model.pkl')
    team_stats_path = os.path.join(PROJECT_ROOT, 'models', 'team_statistics.pkl')
    venue_path = os.path.join(PROJECT_ROOT, 'data', 'processed', 'venue_statistics_complete.csv')
    players_path = os.path.join(PROJECT_ROOT, 'data', 'global_cricket_players_fixed.json')
    
    print(f"ğŸ“‚ Loading model from: {model_path}")
    with open(model_path, 'rb') as f:
        match_model = pickle.load(f)
    print("âœ… Match Predictor Model Loaded")
    
    print(f"ğŸ“‚ Loading team stats from: {team_stats_path}")
    with open(team_stats_path, 'rb') as f:
        team_stats = pickle.load(f)
    print("âœ… Team Statistics Loaded")
    
    print(f"ğŸ“‚ Loading venue stats from: {venue_path}")
    venue_stats = pd.read_csv(venue_path)
    print(f"âœ… Venue Statistics Loaded ({len(venue_stats)} venues)")
    
    print(f"ğŸ“‚ Loading players from: {players_path}")
    with open(players_path, 'r') as f:
        players_data = json.load(f)
    
    players_df = pd.DataFrame(players_data)
    print(f"âœ… Players Database Loaded ({len(players_df)} players)")
    
except Exception as e:
    print(f"âŒ Error loading data: {e}")
    match_model = None
    team_stats = {}
    venue_stats = pd.DataFrame()
    players_df = pd.DataFrame()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPREHENSIVE TEAMS LIST (Including IPL)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INTERNATIONAL_TEAMS = [
    "India", "Australia", "England", "Pakistan", "South Africa", 
    "New Zealand", "West Indies", "Sri Lanka", "Bangladesh", 
    "Afghanistan", "Zimbabwe", "Ireland", "Netherlands", "Scotland"
]

IPL_TEAMS = [
    "Mumbai Indians", "Chennai Super Kings", "Royal Challengers Bangalore",
    "Kolkata Knight Riders", "Delhi Capitals", "Punjab Kings",
    "Rajasthan Royals", "Sunrisers Hyderabad", "Gujarat Titans",
    "Lucknow Super Giants"
]

ALL_TEAMS = sorted(INTERNATIONAL_TEAMS + IPL_TEAMS)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMPREHENSIVE VENUES LIST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VENUES = [
    # India
    "Wankhede Stadium, Mumbai", "Eden Gardens, Kolkata",
    "M. Chinnaswamy Stadium, Bangalore", "Feroz Shah Kotla, Delhi",
    "MA Chidambaram Stadium, Chennai", "Rajiv Gandhi International Stadium, Hyderabad",
    "Punjab Cricket Association Stadium, Mohali", "Narendra Modi Stadium, Ahmedabad",
    "Sawai Mansingh Stadium, Jaipur", "Holkar Cricket Stadium, Indore",
    "Green Park, Kanpur", "Vidarbha Cricket Association Stadium, Nagpur",
    "JSCA International Stadium Complex, Ranchi", "Himachal Pradesh Cricket Association Stadium, Dharamsala",
    "Barabati Stadium, Cuttack", "Dr. Y.S. Rajasekhara Reddy ACA-VDCA Cricket Stadium, Visakhapatnam",
    
    # Australia
    "Melbourne Cricket Ground, Melbourne", "Sydney Cricket Ground, Sydney",
    "Adelaide Oval, Adelaide", "The Gabba, Brisbane",
    "Perth Stadium, Perth", "Bellerive Oval, Hobart", "Manuka Oval, Canberra",
    
    # England
    "Lord's, London", "The Oval, London", "Old Trafford, Manchester",
    "Edgbaston, Birmingham", "Headingley, Leeds", "Trent Bridge, Nottingham",
    "The Rose Bowl, Southampton", "County Ground, Bristol",
    
    # Pakistan/UAE
    "National Stadium, Karachi", "Gaddafi Stadium, Lahore",
    "Rawalpindi Cricket Stadium, Rawalpindi", "Dubai International Cricket Stadium, Dubai",
    "Sharjah Cricket Stadium, Sharjah", "Sheikh Zayed Stadium, Abu Dhabi",
    
    # South Africa
    "The Wanderers Stadium, Johannesburg", "SuperSport Park, Centurion",
    "Newlands, Cape Town", "Kingsmead, Durban", "St George's Park, Port Elizabeth",
    
    # New Zealand
    "Eden Park, Auckland", "Hagley Oval, Christchurch",
    "Basin Reserve, Wellington", "University Oval, Dunedin",
    
    # Sri Lanka
    "R. Premadasa Stadium, Colombo", "Pallekele International Cricket Stadium, Pallekele",
    "Galle International Stadium, Galle",
    
    # West Indies
    "Kensington Oval, Barbados", "Queen's Park Oval, Trinidad",
    "Sabina Park, Jamaica", "Sir Vivian Richards Stadium, Antigua",
    
    # Bangladesh
    "Shere Bangla National Stadium, Dhaka", "Zahur Ahmed Chowdhury Stadium, Chittagong",
    
    # Others
    "Harare Sports Club, Zimbabwe", "Bulawayo Athletic Club, Zimbabwe", "Village, Dublin"
]

VENUES = sorted(VENUES)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ROUTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/match-predictor')
def match_predictor_page():
    return render_template('match_predictor.html')

@app.route('/player-analysis')
def player_analysis_page():
    return render_template('player_analysis.html')

@app.route('/team-selector')
def team_selector_page():
    return render_template('team_selector.html')

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# API ENDPOINTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/api/teams', methods=['GET'])
def get_teams():
    return jsonify({'success': True, 'teams': ALL_TEAMS, 'international': INTERNATIONAL_TEAMS, 'ipl': IPL_TEAMS})

@app.route('/api/venues', methods=['GET'])
def get_venues():
    return jsonify({'success': True, 'venues': VENUES})

@app.route('/api/search-teams', methods=['GET'])
def search_teams():
    query = request.args.get('q', '').lower()
    if not query:
        return jsonify({'success': True, 'teams': ALL_TEAMS})
    filtered = [t for t in ALL_TEAMS if query in t.lower()]
    return jsonify({'success': True, 'teams': filtered})

@app.route('/api/search-venues', methods=['GET'])
def search_venues():
    query = request.args.get('q', '').lower()
    if not query:
        return jsonify({'success': True, 'venues': VENUES})
    filtered = [v for v in VENUES if query in v.lower()]
    return jsonify({'success': True, 'venues': filtered})

@app.route('/api/predict-match', methods=['POST'])
def predict_match():
    try:
        data = request.json
        team1 = data['team1']
        team2 = data['team2']
        venue = data['venue']
        runs = int(data['runs'])
        wickets = int(data['wickets'])
        run_rate = float(data['run_rate'])
        
        t1_stats = team_stats.get(team1, {'wr': 0.5, 'bat_wr': 0.5, 'chase_wr': 0.5, 'avg_score': 150})
        t2_stats = team_stats.get(team2, {'wr': 0.5, 'bat_wr': 0.5, 'chase_wr': 0.5, 'avg_score': 150})
        
        venue_row = venue_stats[venue_stats['venue'].str.contains(venue.split(',')[0], case=False, na=False)]
        
        if len(venue_row) > 0:
            v_avg = venue_row['v_avg'].values[0]
            v_std = venue_row['v_std'].values[0]
            v_bat_adv = venue_row['v_bat_adv'].values[0]
            v_rr = venue_row['v_rr'].values[0]
        else:
            v_avg, v_std, v_bat_adv, v_rr = 165, 25, 0.5, 7.5
        
        score_above_venue = (runs - v_avg) / v_std if v_std > 0 else 0
        team_strength = t1_stats['wr'] - t2_stats['wr']
        situation_advantage = t1_stats['bat_wr'] - t2_stats['chase_wr']
        wickets_remaining = 10 - wickets
        wicket_quality = (wickets_remaining / 10) * (runs / 150)
        big_score = 1 if runs >= (v_avg + 15) else 0
        low_wickets = 1 if wickets <= 5 else 0
        dominant_performance = big_score * low_wickets
        balanced_match = 1 if abs(team_strength) < 0.15 else 0
        score_normalized = runs / v_avg if v_avg > 0 else 1
        overall_strength = (score_above_venue * 0.4 + team_strength * 0.3 + wicket_quality * 0.2 + situation_advantage * 0.1)
        
        user_input = pd.DataFrame({
            'runs': [runs], 'wickets': [wickets], 'rr': [run_rate],
            't1_wr': [t1_stats['wr']], 't2_wr': [t2_stats['wr']],
            't1_bat_wr': [t1_stats['bat_wr']], 't2_chase_wr': [t2_stats['chase_wr']],
            'v_avg': [v_avg], 'v_bat_adv': [v_bat_adv],
            'score_above_venue': [score_above_venue], 'team_strength': [team_strength],
            'situation_advantage': [situation_advantage], 'wickets_remaining': [wickets_remaining],
            'wicket_quality': [wicket_quality], 'big_score': [big_score],
            'low_wickets': [low_wickets], 'dominant_performance': [dominant_performance],
            'balanced_match': [balanced_match], 'score_normalized': [score_normalized],
            'overall_strength': [overall_strength]
        })
        
        if match_model:
            prediction = match_model.predict(user_input)[0]
            probability = match_model.predict_proba(user_input)[0]
            winner = team1 if prediction == 1 else team2
            team1_prob = round(probability[1] * 100, 1)
            team2_prob = round(probability[0] * 100, 1)
        else:
            winner = team1
            team1_prob = 65.0
            team2_prob = 35.0
        
        max_prob = max(team1_prob, team2_prob)
        if max_prob >= 80:
            confidence = "VERY HIGH"
            confidence_desc = "Strong prediction - Clear favorite"
        elif max_prob >= 70:
            confidence = "HIGH"
            confidence_desc = "Good prediction with solid evidence"
        elif max_prob >= 60:
            confidence = "MODERATE"
            confidence_desc = "Slight edge - Could be competitive"
        else:
            confidence = "LOW"
            confidence_desc = "Very close match - High uncertainty"
        
        if runs > v_avg + 20:
            score_analysis = "EXCELLENT SCORE - Well above venue average"
        elif runs > v_avg:
            score_analysis = "GOOD SCORE - Above venue average"
        elif runs > v_avg - 15:
            score_analysis = "PAR SCORE - Around venue average"
        else:
            score_analysis = "BELOW PAR - Below venue average"
        
        prob_diff = abs(team1_prob - team2_prob)
        if prob_diff < 10:
            match_situation = "VERY CLOSE - Could go either way"
        elif prob_diff < 20:
            match_situation = "COMPETITIVE - Slight edge"
        elif prob_diff < 40:
            match_situation = "CLEAR FAVORITE - Strong advantage"
        else:
            match_situation = "DOMINANT - Overwhelming favorite"
        
        return jsonify({
            'success': True,
            'prediction': {
                'winner': winner, 'team1': team1, 'team2': team2,
                'team1_probability': team1_prob, 'team2_probability': team2_prob,
                'confidence': confidence, 'confidence_description': confidence_desc
            },
            'match_details': {
                'venue': venue, 'score': f"{runs}/{wickets}",
                'run_rate': run_rate, 'wickets_remaining': wickets_remaining
            },
            'venue_analysis': {
                'average_score': round(v_avg, 0),
                'batting_first_advantage': round(v_bat_adv * 100, 0),
                'average_run_rate': round(v_rr, 1),
                'score_vs_average': round(runs - v_avg, 0),
                'score_analysis': score_analysis
            },
            'team_analysis': {
                'team1_win_rate': round(t1_stats['wr'] * 100, 1),
                'team2_win_rate': round(t2_stats['wr'] * 100, 1),
                'team1_batting_wr': round(t1_stats['bat_wr'] * 100, 1),
                'team2_chase_wr': round(t2_stats['chase_wr'] * 100, 1),
                'match_situation': match_situation
            }
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400

@app.route('/api/players', methods=['GET'])
def get_all_players():
    try:
        if len(players_df) == 0:
            return jsonify({'success': False, 'error': 'No players loaded'}), 500
        return jsonify({'success': True, 'players': players_df.to_dict('records'), 'count': len(players_df)})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/players/<country>', methods=['GET'])
def get_players_by_country(country):
    try:
        players = players_df[players_df['country'] == country]
        return jsonify({'success': True, 'players': players.to_dict('records'), 'count': len(players)})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
# Add this to your web_complete.py file

# Add this route with your other routes
@app.route('/performance-analysis')
def performance_analysis_page():
    """Performance Analysis page"""
    return render_template('performance_analysis.html')

# Add this API endpoint with your other API endpoints
@app.route('/api/performance-analysis', methods=['POST'])
def performance_analysis():
    """
    Analyze player performance with detailed statistics
    
    Expected JSON input:
    {
        "player1": "Virat Kohli",
        "player2": "Steve Smith",  # Optional
        "period": "career",  # career, recent, year, format
        "analysis_type": "complete"  # complete, batting, bowling, comparison
    }
    """
    try:
        data = request.json
        player1_name = data['player1']
        player2_name = data.get('player2', None)
        period = data.get('period', 'career')
        analysis_type = data.get('analysis_type', 'complete')
        
        # Get player 1 data
        player1_data = players_df[players_df['player_name'].str.contains(player1_name, case=False, na=False)]
        if len(player1_data) == 0:
            return jsonify({'success': False, 'error': f'Player {player1_name} not found'}), 404
        
        player1 = player1_data.iloc[0].to_dict()
        
        # Calculate performance metrics for player 1
        player1_metrics = calculate_performance_metrics(player1)
        
        result = {
            'success': True,
            'player1': {
                'name': player1['player_name'],
                'country': player1['country'],
                'role': player1['role'],
                'metrics': player1_metrics
            }
        }
        
        # If player 2 specified, add comparison
        if player2_name:
            player2_data = players_df[players_df['player_name'].str.contains(player2_name, case=False, na=False)]
            if len(player2_data) > 0:
                player2 = player2_data.iloc[0].to_dict()
                player2_metrics = calculate_performance_metrics(player2)
                
                result['player2'] = {
                    'name': player2['player_name'],
                    'country': player2['country'],
                    'role': player2['role'],
                    'metrics': player2_metrics
                }
                
                result['comparison'] = compare_players(player1_metrics, player2_metrics)
        
        return jsonify(result)
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400

def calculate_performance_metrics(player):
    """Calculate comprehensive performance metrics for a player"""
    
    # Batting metrics
    batting_metrics = {
        'total_runs': sum([
            player.get('odi_runs', 0) or 0,
            player.get('t20i_runs', 0) or 0,
            player.get('ipl_runs', 0) or 0
        ]),
        'average': sum([
            player.get('odi_average', 0) or 0,
            player.get('t20i_average', 0) or 0
        ]) / 2,
        'strike_rate': sum([
            player.get('odi_strike_rate', 0) or 0,
            player.get('t20i_strike_rate', 0) or 0
        ]) / 2,
        'highest_score': max([
            player.get('odi_highest_score', 0) or 0,
            player.get('t20i_highest_score', 0) or 0,
            player.get('ipl_highest_score', 0) or 0
        ]),
        'hundreds': sum([
            player.get('odi_hundreds', 0) or 0,
            player.get('t20i_hundreds', 0) or 0,
            player.get('ipl_hundreds', 0) or 0
        ]),
        'fifties': sum([
            player.get('odi_fifties', 0) or 0,
            player.get('t20i_fifties', 0) or 0,
            player.get('ipl_fifties', 0) or 0
        ])
    }
    
    # Bowling metrics
    bowling_metrics = {
        'total_wickets': sum([
            player.get('odi_wickets', 0) or 0,
            player.get('t20i_wickets', 0) or 0,
            player.get('ipl_wickets', 0) or 0
        ]),
        'bowling_average': sum([
            player.get('odi_bowling_average', 0) or 0,
            player.get('t20i_bowling_average', 0) or 0
        ]) / 2 if player.get('odi_bowling_average') or player.get('t20i_bowling_average') else 0,
        'economy': sum([
            player.get('odi_economy', 0) or 0,
            player.get('t20i_economy', 0) or 0
        ]) / 2 if player.get('odi_economy') or player.get('t20i_economy') else 0
    }
    
    # Overall metrics
    total_matches = sum([
        player.get('odi_matches', 0) or 0,
        player.get('t20i_matches', 0) or 0,
        player.get('ipl_matches', 0) or 0
    ])
    
    # Calculate performance rating
    batting_rating = min((batting_metrics['average'] / 50 * 40) + (batting_metrics['strike_rate'] / 150 * 30) + (batting_metrics['total_runs'] / 10000 * 30), 100)
    bowling_rating = min((bowling_metrics['total_wickets'] / 300 * 50) + (max(0, 10 - bowling_metrics['economy']) / 10 * 50), 100) if bowling_metrics['total_wickets'] > 0 else 0
    
    overall_rating = batting_rating
    if 'All-Rounder' in player.get('role', ''):
        overall_rating = (batting_rating * 0.5 + bowling_rating * 0.5)
    elif 'Bowler' in player.get('role', ''):
        overall_rating = bowling_rating
    
    return {
        'batting': batting_metrics,
        'bowling': bowling_metrics,
        'total_matches': int(total_matches),
        'overall_rating': round(overall_rating, 2),
        'batting_rating': round(batting_rating, 2),
        'bowling_rating': round(bowling_rating, 2)
    }

def compare_players(metrics1, metrics2):
    """Compare two players' metrics"""
    
    comparison = {
        'batting': {
            'runs': 'player1' if metrics1['batting']['total_runs'] > metrics2['batting']['total_runs'] else 'player2',
            'average': 'player1' if metrics1['batting']['average'] > metrics2['batting']['average'] else 'player2',
            'strike_rate': 'player1' if metrics1['batting']['strike_rate'] > metrics2['batting']['strike_rate'] else 'player2'
        },
        'bowling': {
            'wickets': 'player1' if metrics1['bowling']['total_wickets'] > metrics2['bowling']['total_wickets'] else 'player2',
            'economy': 'player1' if metrics1['bowling']['economy'] < metrics2['bowling']['economy'] and metrics1['bowling']['economy'] > 0 else 'player2'
        },
        'overall': {
            'rating': 'player1' if metrics1['overall_rating'] > metrics2['overall_rating'] else 'player2',
            'matches': 'player1' if metrics1['total_matches'] > metrics2['total_matches'] else 'player2'
        }
    }
    
    # Calculate win percentage
    player1_wins = sum([1 for key in comparison['batting'].values() if key == 'player1'])
    player1_wins += sum([1 for key in comparison['bowling'].values() if key == 'player1'])
    player1_wins += sum([1 for key in comparison['overall'].values() if key == 'player1'])
    
    total_comparisons = len(comparison['batting']) + len(comparison['bowling']) + len(comparison['overall'])
    
    comparison['summary'] = {
        'player1_advantages': player1_wins,
        'player2_advantages': total_comparisons - player1_wins,
        'total_categories': total_comparisons
    }
    
    return comparison
@app.route('/api/player/<name>', methods=['GET'])
def get_player_details(name):
    try:
        player = players_df[players_df['player_name'].str.contains(name, case=False, na=False)]
        if len(player) > 0:
            return jsonify({'success': True, 'player': player.iloc[0].to_dict()})
        else:
            return jsonify({'success': False, 'error': 'Player not found'}), 404
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/select-xi', methods=['POST'])
def select_playing_xi():
    try:
        data = request.json
        country = data['country']
        opposition = data.get('opposition', 'Unknown')
        venue = data.get('venue', 'Generic Stadium')
        match_format = data.get('format', 'T20')
        
        team_players = players_df[players_df['country'] == country].copy()
        
        if len(team_players) == 0:
            return jsonify({'success': False, 'error': f'No players found for {country}'}), 404
        
        venue_name = venue.split(',')[0]
        venue_info = venue_stats[venue_stats['venue'].str.contains(venue_name, case=False, na=False)]
        venue_avg_score = venue_info['v_avg'].values[0] if len(venue_info) > 0 else 165
        
        player_scores = []
        for idx, player in team_players.iterrows():
            score = 0
            
            if match_format == 'ODI':
                runs = player.get('odi_runs', 0)
                avg = player.get('odi_average', 0)
                sr = player.get('odi_strike_rate', 0)
                wickets = player.get('odi_wickets', 0)
                economy = player.get('odi_economy', 10)
            else:
                runs = player.get('t20i_runs', 0) if pd.notna(player.get('t20i_runs')) else player.get('ipl_runs', 0)
                avg = player.get('t20i_average', 0) if pd.notna(player.get('t20i_average')) else player.get('ipl_average', 0)
                sr = player.get('t20i_strike_rate', 0) if pd.notna(player.get('t20i_strike_rate')) else player.get('ipl_strike_rate', 0)
                wickets = player.get('t20i_wickets', 0) if pd.notna(player.get('t20i_wickets')) else player.get('ipl_wickets', 0)
                economy = player.get('t20i_economy', 10) if pd.notna(player.get('t20i_economy')) else player.get('ipl_economy', 10)
            
            runs = 0 if pd.isna(runs) else runs
            avg = 0 if pd.isna(avg) else avg
            sr = 0 if pd.isna(sr) else sr
            wickets = 0 if pd.isna(wickets) else wickets
            economy = 10 if pd.isna(economy) else economy
            
            if 'Batsman' in player['role'] or 'Keeper' in player['role'] or 'All-Rounder' in player['role']:
                batting_score = (runs / 100) + (avg / 10) + (sr / 30)
                if venue_avg_score > 180 and sr > 140:
                    batting_score *= 1.2
                elif venue_avg_score < 150 and avg > 35:
                    batting_score *= 1.1
                score += batting_score * 10
            
            if 'Bowler' in player['role'] or 'All-Rounder' in player['role']:
                bowling_score = (wickets / 20) + ((10 - economy) / 2)
                if venue_avg_score < 150:
                    bowling_score *= 1.3
                score += bowling_score * 10
            
            if 'All-Rounder' in player['role']:
                score *= 1.15
            if player.get('is_young_star') == 'Yes':
                score *= 1.05
            
            player_scores.append({
                'name': player['player_name'], 'role': player['role'],
                'batting_position': player.get('batting_position', '5-6'),
                'score': score, 'runs': runs, 'avg': avg, 'sr': sr,
                'wickets': wickets, 'economy': economy
            })
        
        player_scores_df = pd.DataFrame(player_scores).sort_values('score', ascending=False)
        selected_xi = []
        
        openers = player_scores_df[player_scores_df['batting_position'].str.contains('1-2|1-3', na=False)].head(2)
        selected_xi.extend(openers.to_dict('records'))
        remaining = player_scores_df[~player_scores_df['name'].isin([p['name'] for p in selected_xi])]
        
        middle = remaining[remaining['batting_position'].str.contains('3|4|5', na=False)].head(3)
        selected_xi.extend(middle.to_dict('records'))
        remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
        
        all_rounders = remaining[remaining['role'].str.contains('All-Rounder', na=False)].head(2)
        selected_xi.extend(all_rounders.to_dict('records'))
        remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
        
        pace = remaining[remaining['role'].str.contains('Fast', na=False)].head(2)
        selected_xi.extend(pace.to_dict('records'))
        remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
        
        spin = remaining[remaining['role'].str.contains('Spin', na=False)].head(2)
        selected_xi.extend(spin.to_dict('records'))
        remaining = remaining[~remaining['name'].isin([p['name'] for p in selected_xi])]
        
        while len(selected_xi) < 11 and len(remaining) > 0:
            selected_xi.append(remaining.iloc[0].to_dict())
            remaining = remaining.iloc[1:]
        
        batsmen = len([p for p in selected_xi if 'Batsman' in p['role'] or 'Keeper' in p['role']])
        all_rounders_count = len([p for p in selected_xi if 'All-Rounder' in p['role']])
        bowlers = len([p for p in selected_xi if 'Bowler' in p['role'] and 'All-Rounder' not in p['role']])
        
        avg_sr = sum([p['sr'] for p in selected_xi if p['sr'] > 0]) / len([p for p in selected_xi if p['sr'] > 0]) if any(p['sr'] > 0 for p in selected_xi) else 0
        
        strengths = []
        if avg_sr > 135:
            strengths.append(f"âš¡ EXPLOSIVE batting (Avg SR: {avg_sr:.1f})")
        elif avg_sr > 120:
            strengths.append(f"âœ… BALANCED batting (Avg SR: {avg_sr:.1f})")
        if bowlers >= 5:
            strengths.append("ğŸ¯ Strong BOWLING depth")
        if all_rounders_count >= 2:
            strengths.append("âš¡ Excellent BALANCE with all-rounders")
        if venue_avg_score > 180 and avg_sr > 135:
            strengths.append("ğŸ¯ Perfect for HIGH-SCORING venue")
        elif venue_avg_score < 150 and bowlers >= 5:
            strengths.append("ğŸ¯ Strong for LOW-SCORING venue")
        
        return jsonify({
            'success': True, 'players': selected_xi,
            'composition': {
                'batsmen': batsmen, 'all_rounders': all_rounders_count, 'bowlers': bowlers,
                'pace': len([p for p in selected_xi if 'Fast' in p['role']]),
                'spin': len([p for p in selected_xi if 'Spin' in p['role']])
            },
            'venue_info': {
                'avg_score': round(venue_avg_score, 0),
                'type': 'High-Scoring' if venue_avg_score > 180 else 'Moderate' if venue_avg_score > 160 else 'Low-Scoring'
            },
            'strengths': strengths
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400

if __name__ == '__main__':
    print("\n" + "="*70)
    print("ğŸŒ ENHANCED CRICKET ANALYSIS SYSTEM")
    print("="*70)
    print("ğŸ”— Open: http://localhost:5000")
    print("="*70)
    print(f"\nğŸ“Š Loaded:")
    print(f"   Teams: {len(ALL_TEAMS)} (Int + IPL)")
    print(f"   Venues: {len(VENUES)}")
    print(f"   Players: {len(players_df)}")
    print("="*70 + "\n")
    
    app.run(debug=True, port=5000, host='0.0.0.0')



